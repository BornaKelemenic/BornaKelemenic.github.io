import{F as A}from"./chunk-AF4CDQ2G.js";import{a as f,c as o}from"./chunk-OLK2YL67.js";import{V as F,a as E,b as B,f as a,p as m,t as w}from"./chunk-F55HGIM7.js";var y=function(e){return e[e.FALSE=0]="FALSE",e[e.TRUE=1]="TRUE",e}(y||{});function v(e){return e?y.TRUE:y.FALSE}function b(e){return!!e}function R(e){return e.reduce((I,t)=>I+t,0)}function x(e){return e.length?e.reduce((I,t)=>I+t,0)/e.length:0}var i=function(e){return e.OLDEST_FIRST="oldest_first",e.NEWEST_FIRST="newest_first",e.HIGHEST_SUM="highest_sum",e.LOWEST_SUM="lowest_sum",e.HIGHEST_AVERAGE="highest_average",e.LOWEST_AVERAGE="lowest_average",e}(i||{}),U=new Map([[i.NEWEST_FIRST,"session.sortOptions.newestFirst"],[i.OLDEST_FIRST,"session.sortOptions.oldestFirst"],[i.HIGHEST_SUM,"session.sortOptions.highestTotalFirst"],[i.LOWEST_SUM,"session.sortOptions.lowestTotalFirst"],[i.HIGHEST_AVERAGE,"session.sortOptions.highestAverageFirst"],[i.LOWEST_AVERAGE,"session.sortOptions.lowestAverageFirst"]]);var J=(()=>{class e{constructor(){this.sessions$=m(f(()=>o.sessions.orderBy("date").reverse().toArray()))}getFilteredSessions(t){return m(f(()=>a(this,null,function*(){let s=[];switch(t.sortBy){case i.NEWEST_FIRST:{s=yield o.sessions.orderBy("date").reverse().toArray();break}case i.OLDEST_FIRST:{s=yield o.sessions.orderBy("date").toArray();break}case i.HIGHEST_SUM:case i.LOWEST_SUM:case i.HIGHEST_AVERAGE:case i.LOWEST_AVERAGE:{s=yield o.sessions.toArray();let n=new Map;for(let d of s){let u=0,c=0,S=0,l=yield this.getAllShotsFromValidRoundsBySessionId(d.id),h=l.map(T=>T.value);u=R(h),S=x(h),c=l.map(T=>T.isX).filter(T=>!!T).length,n.set(d.id,{scoreTotal:u,xCount:c,avg:S})}t.sortBy===i.HIGHEST_SUM?s=s.sort((d,u)=>{let c=n.get(d.id).scoreTotal,S=n.get(d.id).xCount,l=n.get(u.id).scoreTotal,h=n.get(u.id).xCount;return c===l?h-S:l-c}):t.sortBy===i.LOWEST_SUM?s=s.sort((d,u)=>{let c=n.get(d.id).scoreTotal,S=n.get(d.id).xCount,l=n.get(u.id).scoreTotal,h=n.get(u.id).xCount;return c===l?S-h:c-l}):t.sortBy===i.HIGHEST_AVERAGE?s=s.sort((d,u)=>{let c=n.get(d.id).avg,S=n.get(d.id).xCount,l=n.get(u.id).avg,h=n.get(u.id).xCount;return c===l?h-S:l-c}):t.sortBy===i.LOWEST_AVERAGE&&(s=s.sort((d,u)=>{let c=n.get(d.id).avg,S=n.get(d.id).xCount,l=n.get(u.id).avg,h=n.get(u.id).xCount;return c===l?S-h:c-l}));break}default:s=yield o.sessions.toArray();break}let r=t.shootingType;A(r)&&(s=s.filter(n=>n.shootingType===r));let p=t.targetFace;A(p)&&(s=s.filter(n=>n.targetFace===p));let g=t.distance;return A(g)&&g>0&&(s=s.filter(n=>n.distance===g)),s})))}getAverageScoreBySessionID$(t){return m(f(()=>this.getAllShotsFromValidRoundsBySessionId(t))).pipe(w(s=>s.map(r=>r.value)),w(s=>x(s).toFixed(2)))}getTotalScoreBySessionID$(t){return m(f(()=>this.getAllShotsFromValidRoundsBySessionId(t))).pipe(w(s=>R(s.map(r=>r.value))))}getXCountBySessionID$(t){return m(f(()=>this.getAllShotsFromValidRoundsBySessionId(t))).pipe(w(s=>s.map(r=>r.isX).filter(r=>!!r)),w(s=>s.length))}addSession(t){return a(this,null,function*(){return yield o.sessions.add(B(E({},t),{date:new Date().toISOString(),locked:y.FALSE}))})}deleteSession(t){return a(this,null,function*(){return yield o.transaction("rw",o.sessions,o.rounds,o.shots,()=>a(this,null,function*(){let s=yield this.getRoundsBySessionId(t);for(let r of s){let p=yield this.getShotsByRoundId(r.id);yield o.shots.bulkDelete(p.map(g=>g.id))}yield o.rounds.bulkDelete(s.map(r=>r.id)),yield o.sessions.delete(t)}))})}getSessionById(t){return a(this,null,function*(){return yield o.sessions.get(t)})}updateSession(t,s){return a(this,null,function*(){return yield o.sessions.update(t,E({},s))})}getLatestSession(){return a(this,null,function*(){return yield o.sessions.orderBy("date").reverse().first()})}getRoundsBySessionId(t){return a(this,null,function*(){return yield o.rounds.where({sessionId:t}).toArray()})}getRoundsCountBySessionId(t){return a(this,null,function*(){return yield o.rounds.where({sessionId:t}).count()})}addRound(t){return a(this,null,function*(){return o.rounds.add(t)})}updateRound(t,s){return a(this,null,function*(){return yield o.rounds.update(t,E({},s))})}deleteRound(t){return a(this,null,function*(){return yield o.transaction("rw",o.rounds,o.shots,()=>a(this,null,function*(){let s=yield this.getShotsByRoundId(t);yield o.shots.bulkDelete(s.map(r=>r.id)),yield o.rounds.delete(t)}))})}getShotsByRoundId(t){return a(this,null,function*(){return yield o.shots.where({roundId:t}).toArray()})}getAllShotsBySessionId(t){return a(this,null,function*(){let s=yield this.getRoundsBySessionId(t),r=[];for(let p of s){let g=yield this.getShotsByRoundId(p.id);r.push(...g)}return r})}addShot(t){return a(this,null,function*(){return yield o.shots.add(t)})}addMultipleShots(t){return a(this,null,function*(){return yield o.shots.bulkAdd(t)})}deleteShot(t){return a(this,null,function*(){return yield o.shots.delete(t)})}updateShot(t,s){return a(this,null,function*(){return yield o.shots.update(t,s)})}addShotsForRound(t,s){return a(this,null,function*(){o.transaction("rw",o.sessions,o.rounds,o.shots,()=>a(this,null,function*(){yield o.shots.where({roundId:t}).delete(),yield o.shots.bulkAdd(s);let r=yield o.rounds.get(t),p=yield o.sessions.where({id:r.sessionId}).first();yield this.updateRound(t,{countsTowardsStats:v(s.length===p.arrowCount)})}))})}getAllShotsFromValidRoundsBySessionId(t){return a(this,null,function*(){let s=yield o.rounds.where({sessionId:t,countsTowardsStats:y.TRUE}).toArray(),r=[];for(let p of s){let g=yield this.getShotsByRoundId(p.id);r.push(...g)}return r})}static{this.\u0275fac=function(s){return new(s||e)}}static{this.\u0275prov=F({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();export{v as a,b,R as c,x as d,i as e,U as f,J as g};
